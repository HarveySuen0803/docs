## 分片架构设计

### 分库分表介绍

MySQL 数据库的分库分表主要是为了应对大数据量或者高并发的场景，分库分表存在分布式事务一致性的问题，跨结点关联查询，分页查询，排序查询的问题，主键避重的问题。

### 什么时候需要分库

单库无法承受当前的并发量，请求量极高，需要大量的计算和 IO 时，就需要分库。

### 什么时候需要分表

单表数据量过大时，就需要分表。

### 为什么要谨慎分库分表

分库分表虽然可以拆分业务，可以降低一定系统间的影响，但是导致的问题太多，例如，事务问题，表连接问题。这些问题会导致开发复杂度提高。

阿里巴巴 Java 开发手册推荐：单表行数超过 500 万行或单表容量超过 2GB，才推荐进行分库分表。如果预计三年后的数据量根本达不到这个级别，请不要在创建表时进行分库分表。

### 水平分库介绍

水平分库：将一个库的数据拆分到多个库中，通过 Id 取模的方式路由到不同的库中。例如，将 db_user 拆分成 db_user_0, db_user_1, db_user_2 三个库，通过 id % 3 的方式选择不同的库进行访问。

### 垂直分库介绍

垂直分库：将一个库的表拆分到多个库中。例如，将 db_service 拆分成 db_user, db_order, db_sku，不同的业务访问不同的库。

### 水平分表介绍

水平分表：将一个表的数据拆分到多个表中，通过 Id 取模的方式路由到不同的表中。例如，将 tb_user 拆分成 tb_user_0, tb_user_1, tb_user_2 三个表，通过 id % 3 的方式选择不同的表进行访问。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407281755110.png)

### 垂直分表介绍

垂直分表：将一个表的字段拆分到多个表中，根据字段不同的访问频率进行冷热隔离。例如，将 user(id, name, desc) 拆分成 user(id, name) 和 user_detail(id, desc)。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407281757890.png)

## 如何在程序中访问多个数据源

在分库分表的场景下，一个应用程序可能需要连接多个数据源。之前，一个应用程序只需要设置一套数据源连接配置，现在我们需要设置多套数据源配置，并在应用程序中进行相应的管理和使用。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407281816491.png)

主流的实现方式是 数据访问层封装 和 中间件封装 两种。

### 数据访问层封装

可以在自己在应用程序中，单独搭建一层数据访问层。在这个数据访问层里去管理不同的数据源，去操作 Dao，对外提供访问数据源的 API。业务层不再去直接操作 Dao 或 Mapper，而是调用数据访问层的 API 来访问数据库。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407281828538.png)

常见的数据访问层封装框架：ShardingSphere JDBC

### 中间件封装

中间件封装指的是使用专门的数据库中间件来实现分库分表的逻辑。中间件可以自动处理数据的路由、查询、插入、更新和删除操作，开发者无需在代码中实现这些逻辑。

本质上中间件封装相较于数据访问层封装，就是将数据访问层单独抽离应用程序，作为了一个中间件。最直白的话就是，数据访问层的代码单独抽了出来，将它作为一个中间件，原来的应用程序去调用中间件的接口。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407281834490.png)

常见的中间件封装框架：ShardingSphere Proxy, MyCat